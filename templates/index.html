<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PGA & HS Lookup Tool</title>
<style>
  body { font-family:'Segoe UI',sans-serif; background:#f0f2f5; margin:0; padding:2rem; }
  h1 { text-align:center; color:#333; }
  form, .card { background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin:1rem auto; max-width:800px; padding:1.5rem; }
  label { display:block; margin-top:1rem; font-weight:600; }
  input { width:100%; padding:.75rem; margin-top:.25rem; border:1px solid #ccc; border-radius:4px; }
  button { width:100%; padding:.75rem; margin-top:1rem; border:none; border-radius:4px; background:#007BFF; color:#fff; font-size:1rem; cursor:pointer; }
  button:hover { background:#0056b3; }
  .download { text-align:right; margin-bottom:1rem; }
  .download a { color:#007BFF; font-weight:600; text-decoration:none; }
  .spinner { display:none; margin:2rem auto; width:48px; height:48px; border:5px solid #ccc; border-top-color:#007BFF; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .record { border-top:1px solid #eee; padding:1rem 0; }
  .record:first-child { border-top:none; }
  .field { display:flex; padding:.25rem 0; }
  .field-key { flex:0 0 40%; font-weight:600; }
  .field-value { flex:1; word-break:break-word; }
  .no-data { text-align:center; padding:2rem; color:#777; }
</style>
</head>
<body>

<h1>PGA & HS Lookup Tool</h1>

<form id="lookupForm">
  <label>HS Code (required)<input name="hs_code" required placeholder="e.g. 3403115000"></label>
  <label>Product Description (optional)<input name="description" placeholder="e.g. organic soap"></label>
  <label>Country of Export (ISO)<input name="country_export" maxlength="2" placeholder="e.g. US"></label>
  <label>Country of Manufacture (ISO)<input name="country_manufacture" maxlength="2" placeholder="e.g. CN"></label>
  <button type="submit">Lookup</button>
</form>

<div id="spinner" class="spinner"></div>
<div id="results"></div>

<script>
function linkify(text) {
  const urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
}

async function renderSection(title, records) {
  const container = document.createElement('div');
  container.className = 'card';
  container.innerHTML = `<h2>${title}</h2>`;
  if (!records.length) {
    container.innerHTML += `<div class="no-data">No ${title.toLowerCase()} found.</div>`;
    return container;
  }
  records.forEach(record => {
    const recDiv = document.createElement('div');
    recDiv.className = 'record';
    for (const [key, value] of Object.entries(record)) {
      const val = value == null ? '' : linkify(String(value));
      recDiv.innerHTML += `
        <div class="field">
          <div class="field-key">${key}</div>
          <div class="field-value">${val}</div>
        </div>`;
    }
    container.appendChild(recDiv);
  });
  return container;
}

document.getElementById('lookupForm').addEventListener('submit', async e => {
  e.preventDefault();
  const results = document.getElementById('results');
  const spinner = document.getElementById('spinner');
  results.innerHTML = '';
  spinner.style.display = 'block';

  try {
    const data = Object.fromEntries(new FormData(e.target));
    const res = await fetch('/lookup', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const json = await res.json();

    const downloadDiv = document.createElement('div');
    downloadDiv.className = 'download';
    const blob = new Blob([JSON.stringify(json,null,2)], {type:'application/json'});
    downloadDiv.innerHTML = `<a href="${URL.createObjectURL(blob)}" download="lookup.json">Download JSON</a>`;
    results.appendChild(downloadDiv);

    results.appendChild(await renderSection('HS Chapters Lookup', json.hs_chapters));
    results.appendChild(await renderSection('PGA HTS Lookup', json.pga_hts));
    results.appendChild(await renderSection('HS Restrictions Rules', json.hs_rules));
  } finally {
    spinner.style.display = 'none';
  }
});
</script>

</body>
</html>
